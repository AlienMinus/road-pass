<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel - Transit Passes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="logo.png" type="image/png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
          sans-serif;
      }

      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .admin-header h1 {
        margin: 0;
        font-weight: 700;
        font-size: 28px;
      }

      .admin-header p {
        margin: 5px 0 0 0;
        opacity: 0.95;
        font-size: 14px;
      }

      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #667eea;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
      }

      .search-box input {
        padding: 10px 15px;
        border: 1px solid #d0d0d0;
        border-radius: 6px;
        font-size: 14px;
      }

      .btn-group-custom {
        display: flex;
        gap: 8px;
      }

      .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .table {
        margin: 0;
        font-size: 13px;
      }

      .table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }

      .table th {
        font-weight: 600;
        color: #333;
        padding: 12px 15px;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }

      .table td {
        padding: 12px 15px;
        vertical-align: middle;
        color: #555;
      }

      .table tbody tr:hover {
        background: #f8f9fa;
      }

      .pass-no {
        font-weight: 600;
        color: #0033a1;
      }

      .action-buttons {
        display: flex;
        gap: 6px;
      }

      .btn-sm-custom {
        padding: 5px 10px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .btn-view {
        background: #667eea;
        color: white;
      }

      .btn-view:hover {
        background: #764ba2;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-valid {
        background: #d4edda;
        color: #155724;
      }

      .status-expired {
        background: #f8d7da;
        color: #721c24;
      }

      .loading {
        text-align: center;
        padding: 40px 20px;
        color: #667eea;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .modal-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }

      .modal-title {
        font-weight: 700;
        color: #333;
      }

      @media (max-width: 1024px) {
        .stats-row {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .admin-header h1 {
          font-size: 22px;
        }

        .admin-header p {
          font-size: 12px;
        }

        .stats-row {
          grid-template-columns: 1fr;
          gap: 12px;
          margin-bottom: 20px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-value {
          font-size: 24px;
        }

        .stat-label {
          font-size: 10px;
        }

        .controls {
          flex-direction: column;
          gap: 8px;
        }

        .search-box {
          min-width: 100%;
        }

        .search-box input {
          padding: 8px 12px;
          font-size: 13px;
        }

        .btn-group-custom {
          flex-direction: column;
          width: 100%;
        }

        .btn-group-custom button {
          width: 100%;
          font-size: 13px;
        }

        /* Hide non-critical columns on tablet */
        .table {
          font-size: 11px;
        }

        .table th,
        .table td {
          padding: 6px 8px;
        }

        .table th {
          font-size: 9px;
        }

        /* Hide columns: Route, Quantity, Vehicle, Gross Weight, Created */
        .table th:nth-child(5),
        .table td:nth-child(5),
        .table th:nth-child(6),
        .table td:nth-child(6),
        .table th:nth-child(7),
        .table td:nth-child(7),
        .table th:nth-child(8),
        .table td:nth-child(8),
        .table th:nth-child(10),
        .table td:nth-child(10) {
          display: none;
        }

        .action-buttons {
          flex-direction: column;
          gap: 4px;
        }

        .btn-sm-custom {
          padding: 4px 8px;
          font-size: 11px;
        }

        .back-link {
          font-size: 12px;
          margin-bottom: 15px;
        }
      }

      @media (max-width: 480px) {
        .admin-header {
          padding: 20px 0;
        }

        .container {
          padding: 0 10px;
        }

        .admin-header h1 {
          font-size: 18px;
        }

        .stats-row {
          gap: 8px;
        }

        .stat-card {
          padding: 12px;
          border-left-width: 3px;
        }

        .stat-value {
          font-size: 20px;
        }

        .stat-label {
          font-size: 9px;
        }

        .table {
          font-size: 10px;
        }

        .table th,
        .table td {
          padding: 5px 6px;
        }

        .btn-sm-custom {
          padding: 3px 6px;
          font-size: 10px;
        }

        .pass-no {
          font-size: 10px;
        }

        /* Show only Pass No, Licensee, Mineral, Status, Actions */
        .table th:nth-child(n + 4):not(:nth-child(9)):not(:nth-child(11)),
        .table td:nth-child(n + 4):not(:nth-child(9)):not(:nth-child(11)) {
          display: none;
        }
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
      }

      .back-link:hover {
        color: #764ba2;
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <div class="container">
        <a href="status.html" class="back-link">
          <i class="bi bi-arrow-left"></i> Back to Status
        </a>
        <h1><i class="bi bi-shield-lock"></i> Admin Panel</h1>
        <p>Manage all transit passes</p>
      </div>
    </div>

    <div class="container">
      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Total Passes</div>
          <div class="stat-value" id="totalPasses">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Valid Passes</div>
          <div class="stat-value" id="validPasses">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Expired Passes</div>
          <div class="stat-value" id="expiredPasses">0</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by pass no., licensee, mineral, destination..."
            onkeyup="filterTable()"
          />
        </div>
        <div class="btn-group-custom">
          <button class="btn btn-primary btn-sm" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteAll()">
            <i class="bi bi-trash"></i> Delete All
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <div id="loadingMessage" class="loading" style="display: none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading passes...</p>
        </div>

        <div id="emptyState" class="empty-state" style="display: none">
          <div class="empty-state-icon">üìã</div>
          <h5>No Passes Found</h5>
          <p>Start by creating a new transit pass</p>
        </div>

        <table class="table table-hover" id="passTable" style="display: none">
          <thead>
            <tr>
              <th>Pass No.</th>
              <th>Licensee</th>
              <th>Mineral</th>
              <th>Destination</th>
              <th>Route</th>
              <th>Quantity</th>
              <th>Vehicle</th>
              <th>Gross Weight</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this pass?</p>
            <p id="deletePassInfo" style="font-weight: 600; color: #0033a1"></p>
            <p style="font-size: 12px; color: #666; margin-top: 15px">
              <strong>Warning:</strong> This action cannot be undone.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDelete()"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script>
      let API_URL = "https://road-pass.onrender.com/api/transit-pass";
      let allPasses = [];
      let passToDelete = null;
      const deleteModal = new bootstrap.Modal(
        document.getElementById("deleteModal")
      );

      // Load API URL from config
      async function initializeAPI() {
        try {
          const response = await fetch('/api/config');
          if (response.ok) {
            const config = await response.json();
            API_URL = config.API_URL;
            console.log('Using API URL from .env:', API_URL);
          }
        } catch (error) {
          console.log('Using default API URL:', API_URL);
        }
      }

      // Initialize before loading passes
      window.addEventListener('load', () => {
        initializeAPI().then(() => loadPasses());
      });

      // Format date to readable format
      function formatDate(isoString) {
        if (!isoString) return "N/A";
        const date = new Date(isoString);
        const day = String(date.getDate()).padStart(2, "0");
        const month = date.toLocaleString("en-US", { month: "short" });
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }

      // Get pass status
      function getPassStatus(fromDateTime, toDateTime) {
        const now = new Date();
        const to = new Date(toDateTime);

        if (now <= to) {
          return { status: "Valid", class: "status-valid" };
        } else {
          return { status: "Expired", class: "status-expired" };
        }
      }

      // Load and display all passes
      async function loadPasses() {
        const loading = document.getElementById("loadingMessage");
        const emptyState = document.getElementById("emptyState");
        const table = document.getElementById("passTable");
        const tableBody = document.getElementById("tableBody");

        loading.style.display = "block";
        emptyState.style.display = "none";
        table.style.display = "none";

        try {
          const response = await fetch(`${API_URL}/all`);
          const result = await response.json();

          loading.style.display = "none";

          if (result.success && Array.isArray(result.data)) {
            allPasses = result.data;

            if (allPasses.length === 0) {
              emptyState.style.display = "block";
              updateStats(0, 0, 0);
              return;
            }

            // Update stats
            const valid = allPasses.filter((p) => {
              const st = getPassStatus(p.fromDateTime, p.toDateTime);
              return st.status === "Valid";
            }).length;
            const expired = allPasses.length - valid;
            updateStats(allPasses.length, valid, expired);

            // Populate table
            tableBody.innerHTML = "";
            allPasses.forEach((pass) => {
              const { status, class: statusClass } = getPassStatus(
                pass.fromDateTime,
                pass.toDateTime
              );

              const row = document.createElement("tr");
              row.innerHTML = `
              <td class="pass-no">${pass.passNo || "-"}</td>
              <td>${pass.licensee || "-"}</td>
              <td>${pass.mineral || "-"}</td>
              <td>${pass.destination || "-"}</td>
              <td>${pass.route || "-"}</td>
              <td>${pass.quantity || "-"}</td>
              <td>${pass.vehicle || "-"}</td>
              <td>${pass.grossWeight || "-"}</td>
              <td>
                <span class="status-badge ${statusClass}">${status}</span>
              </td>
              <td>${formatDate(pass.createdAt)}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-sm-custom btn-view" onclick="viewPass('${
                    pass._id
                  }')">
                    <i class="bi bi-eye"></i> View
                  </button>
                  <button class="btn-sm-custom btn-delete" onclick="showDeleteConfirm('${
                    pass._id
                  }', '${pass.passNo}')">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>
              </td>
            `;
              tableBody.appendChild(row);
            });

            table.style.display = "table";
          }
        } catch (error) {
          loading.style.display = "none";
          console.error("Error loading passes:", error);
          emptyState.innerHTML = `
          <div class="empty-state-icon">‚ùå</div>
          <h5>Error Loading Data</h5>
          <p>${error.message}</p>
        `;
          emptyState.style.display = "block";
        }
      }

      // Update statistics
      function updateStats(total, valid, expired) {
        document.getElementById("totalPasses").textContent = total;
        document.getElementById("validPasses").textContent = valid;
        document.getElementById("expiredPasses").textContent = expired;
      }

      // Filter table by search input
      function filterTable() {
        const input = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const table = document.getElementById("passTable");
        const rows = table
          .getElementsByTagName("tbody")[0]
          .getElementsByTagName("tr");

        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(input) ? "" : "none";
        });
      }

      // View pass details
      function viewPass(passId) {
        window.location.href = `pass-detail.html?id=${passId}`;
      }

      // Show delete confirmation
      function showDeleteConfirm(passId, passNo) {
        passToDelete = passId;
        document.getElementById(
          "deletePassInfo"
        ).textContent = `Pass No: ${passNo}`;
        deleteModal.show();
      }

      // Confirm and delete pass
      async function confirmDelete() {
        if (!passToDelete) return;

        try {
          const response = await fetch(`${API_URL}/${passToDelete}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            deleteModal.hide();
            allPasses = allPasses.filter((p) => p._id !== passToDelete);
            loadPasses();
          } else {
            alert("Error deleting pass");
          }
        } catch (error) {
          console.error("Error deleting pass:", error);
          alert("Error deleting pass: " + error.message);
        }

        passToDelete = null;
      }

      // Delete all passes with confirmation
      function deleteAll() {
        if (allPasses.length === 0) {
          alert("No passes to delete");
          return;
        }

        if (
          confirm(
            `Are you sure you want to delete ALL ${allPasses.length} passes? This cannot be undone.`
          )
        ) {
          deleteAllConfirmed();
        }
      }

      // Delete all confirmed
      async function deleteAllConfirmed() {
        const toDelete = allPasses.map((p) => p._id);
        let deleted = 0;
        let failed = 0;

        for (const passId of toDelete) {
          try {
            const response = await fetch(`${API_URL}/${passId}`, {
              method: "DELETE",
            });

            if (response.ok) {
              deleted++;
            } else {
              failed++;
            }
          } catch (error) {
            failed++;
          }
        }

        alert(`Deleted ${deleted} passes. Failed: ${failed}`);
        loadPasses();
      }

      // Refresh data
      function refreshData() {
        loadPasses();
      }

      // Load on page load
      window.addEventListener("load", loadPasses);
    </script>
  </body>
</html>
